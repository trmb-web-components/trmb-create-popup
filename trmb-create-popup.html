<link rel="import" href="../@polymer/polymer/polymer-element.html">
<link rel="import" href="../@polymer/polymer/lib/elements/dom-if.html">
<link rel="import" href="../@polymer/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../@polymer/polymer/lib/utils/resolve-url.html">

<link rel="import" href="../trmb-css/dist/components/common.css.min.html">
<link rel="import" href="../trmb-css/dist/components/form.css.min.html">
<link rel="import" href="../trmb-css/dist/components/button.css.min.html">
<link rel="import" href="../trmb-css/dist/components/profilex-image.css.min.html">
<link rel="import" href="../trmb-css/dist/components/xy-grid.css.min.html">
<dom-module id="trmb-create-popup">

    <template>
        <style include="common-css">
            
        </style>
        <style include="form-css">
            
        </style>
        <style include="button-css">
            
        </style>
        <style include="xy-grid-css">
            
        </style>
        <style include="profilex-image-css">
            
        </style>
    <style>
        .popup-container {
            position: fixed;
            /* Stay in place */
            z-index: 1;
            /* Sit on top */
            padding-top: 100px;
            /* Location of the box */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            overflow: auto;
            /* Enable scroll if needed */
            background-color: rgb(0, 0, 0);
            /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
        }
        /* Modal Content */
        
        .callout {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 450px;
        }
        /* The Close Button */
        
        .close {
            color: #aaaaaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .morelink {
            margin: 0 0 1rem;
        }
        
        [hidden] {
            display: none !important;
        }
        .alert-box.error {
            color: darkred;
            background-color: #FFFFFF;
            width:100%;
            padding: 5px;
        }
        .alert-box.warning {
            color: #f08a24;
            background-color: #FFFFFF;
            width:100%;
            padding: 5px;
        }
        .alert-box.success {
            color:darkgreen;
            background-color: #FFFFFF;
            width:100%;
            padding: 5px;
        }
        .plus-icon {
            display:block;
            width: 20px;
            height: 20px;
            background-image: url(images/icon_line_plus_16-32-64.svg);
            padding: 8px;
            padding-bottom: 7px;
            cursor: pointer;
        }
        .minus-icon {
            display:block;
            width: 20px;
            height: 20px;
            background-image: url(images/icon_line_minus_24-48-96.svg);
            padding: 8px;
            padding-bottom: 7px;
            cursor: pointer;
        }
        .first-child {
            margin-top: 21px;
        }
        .display-none {
            display: none;
        }
        .display-block {
            display: block;
        }
    </style>
    <template is="dom-if" if="{{showPopupBoolean}}" id="createpopup">
   <div class="popup-container" id="createpopup-container">
      <!--div class="popup-content" !-->
      <div class="cell large-10 callout secondary"  id="createpopup-container">
         <span class="close" on-click="_closeBox">&times;</span>
         <h3>{{popupConfig.heading}}</h3>
         <!--div class="popup-header">
            <h2 class="popup-header-title"></h2>
            <span class="close" on-click="_closeBox">&times;</span>
            </div!-->
         <div class="popup-body">
    <dom-if if="{{!_isConfigReadyAsBool}}" id="ready-loading">
        <template >
            Loading..
        </template>
    </dom-if>
    <dom-if if="{{_isCreated}}">
        <template>
                 <div class="alert-box success">   {{popupConfig.message.success}}. <br/> User is id {{savedForm.id}}</div>
                </template>
    </dom-if>
    <dom-if if="{{_isError}}">
        <template>
                 <div class="alert-box warning">   {{popupConfig.message.warning}}</div>
                </template>
    </dom-if>
    <dom-if if="{{_isSaving}}">
        <template>
           Please wait.. saving..
        </template>
    </dom-if>
    <form name="create-profilex-form" id="create-popup-form">
        <template is="dom-repeat" items="{{popupConfig.fields}}" index-as="fieldIndex">
        <dom-if if="{{checkFieldType(item.type, 'image', item.showFieldOn)}}"> 
            <template>
                <div class="profilex-image mini">
                    <img id="profilex-image-preview" />
                    <span class="edit-icon" on-click="_openFileBrowse"></span>
                    <input type="file" name="file" id="profilex-image-file" on-change="_showPreview"/>
                </div>
            </template>
        </dom-if>
        <template is="dom-if" if="{{checkFieldType(item.type, 'text', item.showFieldOn)}}">
            <div class="grid-x">
                <template is="dom-repeat" items="{{item.values}}" as="itemValue" index-as="itemIndex">
                    <div class="cell large-10">
                    <template is="dom-if"  if="{{!_hasMoreField(itemIndex)}}">
                        <label>{{item.label}}: </label>
                    </template>
                    <input type="text" value="{{itemValue::change}}" name$="{{_getItemName(item.name, itemIndex)}}" required="{{item.required}}">
                    </div>
                    <template is="dom-if" if="{{item.multiple}}">
                                    <div class="cell large-1">
                                        <i class$="{{_addIconClassName('plus-icon', itemIndex)}}" on-click="_addMoreField"></i>
                                    </div>
                                </template>
                    <template is="dom-if" if="{{_hasMoreField(itemIndex)}}">
                                    <div class="cell large-1">
                                        <i class$="{{_addIconClassName('minus-icon', itemIndex)}}"  on-click="_removeField"></i>
                                    </div>
                                </template>

                    </template>
                    <template is="dom-if" if="{{!item.multiple}}">
                                <div class="cell large-10">
                                    <label>{{item.label}}: </label><input type="text" value="{{item.value::change}}" name="{{item.name}}" required="{{item.required}}">
                                    <small class$="{{_addDisplayClassName('form-error', item.error)}}">{{item.errorMessage}}</small>
                                </div>
                            </template>
                    </div>
        </template>
        <template is="dom-if" if="{{checkFieldType(item.type, 'radio', item.showFieldOn)}}">
                     <div class="grid-x">
                        <div class="cell large-10">
                           <label>{{item.label}}: </label>
                           <template is="dom-repeat" items="{{item.options}}" as="option">
                              <input type="radio" name="{{item.name}}" value="{{option.value}}"> {{option.value}}
                           </template>
        </div>
        </div>
        </template>
        <template is="dom-if" if="{{checkFieldType(item.type, 'date', item.showFieldOn)}}">
                     <div class="grid-x">
                        <div class="cell large-10">
                           <label>{{item.label}}: </label><input type="date" value="" name="{{item.name}}">
                        </div>
                     </div>
                  </template>
        <template is="dom-if" if="{{checkFieldType(item.type, 'dropdown', item.showFieldOn)}}">
                     <div class="grid-x">
                        <div class="cell large-10">
                           <label>{{item.label}}: </label>
                           <select name="{{item.name}}">
                              <template is="dom-repeat" items="{{item.options}}" as="option">
                                 <option value="{{option.value}}">{{option.name}}</option>
                              </template>
        </select>
        </div>
        </div>
        </template>
        <template is="dom-if" if="{{checkFieldType(item.type, 'toggle', item.showFieldOn)}}">
                     <div class="grid-x">
                        <div class="large-12 columns morelink">
                           <a id="{{field.id}}" on-click="_toggle"> {{item.label}}</a><br/>
                        </div>
                     </div>
                  </template>

        </template>
    </form>
    </div>
    <div class="popup-footer">
        <button class="button button-primary" on-click="_closeBox">{{popupConfig.button.cancel}}</button>
        <button class="button button-primary" on-click="_submitBox">{{popupConfig.button.add}}</button>
    </div>
    </div>
    <!--/div!-->
    </div>
    </template>
    </template>

    <script>
        /**
         * @customElement
         * @polymer
         */
        class TrmbCreatePopup extends Polymer.Element {

            static get is() {
                return 'trmb-create-popup';
            }
            static get properties() {
                return {
                    showPopupBoolean: Boolean,
                    showPopup: {
                        type: String,
                        notify: true,
                        observer: '_showPopupToggle'
                    },
                    isConfigReady: {
                        type: String,
                        observer: '_onConfigReady'
                    },
                    _isConfigReadyAsBool: {
                        type: Boolean,
                        value: true
                    },
                    type: {
                        type: String,
                        observer: '_onTypeChanged'
                    },
                    layoutSchema: {
                        type: String,
                        observer: '_onLayoutChanged',
                    },
                    updatedLayoutSchema: {
                        type: Object,
                        value: {},
                    },
                    popupConfig: {
                        type: Object,
                        notify: true
                    },
                    apiUrl: String,
                    accessToken: String,
                    xApikey: String,
                    sendAsJson: {
                        type: String,
                        value: "true"
                    },
                    savedForm: Object,
                    _isCreated: {
                        type: Boolean,
                        value: false
                    },
                    _isError: {
                        type: Boolean,
                        value: false
                    },
                    _isSaving : {
                        type: Boolean,
                        value: false
                    }
                };
            }
            ready() {
                super.ready();
                if (undefined == this.showPopup) {
                    this.showPopupBoolean = true;
                    this.setAttribute('show-popup', true);
                }
            }
            _closeBox() {
                this.popupConfig.fields.forEach(function(field){
                    field.value = null;
                    field.error = false;
                    if( field.multiple ) {
                        field.values = [''];
                    }
                });
                var otherProperties = [];
                otherProperties.push({'name': '_isError', value: false});
                otherProperties.push({'name': '_isCreated', value: false});
                this._reRenderPopup(this.popupConfig, otherProperties);
                window.setTimeout(function(){
                    //just wait for 1 sec
                }.bind(this), 1000);
                this.showPopupBoolean = false;
                this.setAttribute('show-popup', false);
            }
            _showPopupToggle() {
                if (this.showPopup.toLowerCase() == 'true') {
                    this.showPopupBoolean = true;
                } else {
                    this.showPopupBoolean = false;
                }
            }
            _submitBox() {
                var formData = new FormData(this.shadowRoot.getElementById('create-popup-form'));
                var convertedJSON = {},
                    it = formData.entries(),
                    n;

                while (n = it.next()) {
                    if (!n || n.done) break;
                    convertedJSON[n.value[0]] = n.value[1];
                }

                var formObjectData = {};
                var formHasError = false;

                this.popupConfig.fields.forEach(function(field) {
                    if( field.type != 'image') {
                        formObjectData[field.name] = field.value || field.values.join('').split('');
                        if (field.required && !field.value) {
                            field.error = true;
                            formHasError = true;
                        }
                    }
                });

                convertedJSON = formObjectData;

                if (formHasError) {
                    this._reRenderPopup(this.popupConfig);
                } else {
                    this._isSaving = true;
                    var xhr = this._generateXHRObject('POST', this.apiUrl);

                    if (this.sendAsJson == 'true') {
                        xhr.send(JSON.stringify(convertedJSON));
                    } else {
                        xhr.send(formData);
                    }
                }
            }
            _generateXHRObject(method, url) {
                var xhr = new XMLHttpRequest();
                
                xhr.onreadystatechange = this._xhrHandler.bind(this);

                xhr.open( method, url);
                xhr.setRequestHeader('Accept', 'application/json');
                if (this.xApikey) {
                    xhr.setRequestHeader('x-apikey', this.xApikey);
                } else if (this.accessToken) {
                    xhr.setRequestHeader("Authorization", "Bearer " + this.accessToken)
                }
                if (this.sendAsJson == 'true') {
                    xhr.setRequestHeader("Content-Type", "application/json");
                }
                return xhr;
            }
            _xhrHandler(e) {
                if (e.target.readyState === 4) {
                    this._isSaving = false; 
                    var photo = this.shadowRoot.getElementById('profilex-image-file');
                    var file = photo.files[0];
                    this.popupConfig.fields.forEach(function(field) {
                        field.error = false;
                    });
                    this._reRenderPopup(this.popupConfig);
                    if (e.target.status === 201 || e.target.status === 200 ) {
                        this._isCreated = true;
                        this.savedForm = JSON.parse(e.target.response);
                        if(this.savedForm.id) {
                            var data = new FormData();
                            if(file && file.size > 0 ) {
                                data.append('file', file, file.name);
                                var xhr = new XMLHttpRequest();             
                                xhr.onreadystatechange = this._xhrHandler.bind(this);
                                xhr.open('PUT', this.apiUrl + '/'+ this.savedForm.id + '/image');
                                if (this.xApikey) {
                                    xhr.setRequestHeader('x-apikey', this.xApikey);
                                } else if (this.accessToken) {
                                    xhr.setRequestHeader("Authorization", "Bearer " + this.accessToken)
                                }
                                xhr.send(data);
                            }
                        }
                    } else {
                        this._isError = true;
                    }
                }
            }
            _onLayoutChanged() {
                if (this.layoutSchema) {
                    this.onBeforeLoadConfig(JSON.parse(this.layoutSchema));
                }
            }
            _onTypeChanged() {
                if (this.type && !this.layoutSchema) {
                    //Load layout schema based on the type
                    this.loadJSON(this.resolveUrl('layoutSchema/' + this.type + '.json'), function(response) {
                        // Parse JSON string into object
                        //this.onBeforeLoadConfig(JSON.parse(response));
                        this.layoutSchema = response;
                    }.bind(this));
                }
            }

            _onConfigReady() {
                this._isConfigReadyAsBool = (this.isConfigReady == undefined || (this.isConfigReady.toLowerCase() == 'true'));
                //this.onBeforeLoadConfig(this.layoutSchema);
            }
            onBeforeLoadConfig(layoutSchema) {
                //this.callFunc = new Function('return ' + this.onPopupLoad);
                //this.callFunc(); // can now be called here or elsewhere in the Polymer object
                if (this._isConfigReadyAsBool) {
                    layoutSchema.fields.forEach(function(field) {
                        if (field.type == "toggle") {
                            this[field.modelKey] = field.value;
                            field.label = (field.value) ? field.labelOn : field.labelOff;
                        }
                    }.bind(this));
                    this.popupConfig = layoutSchema;
                } else {
                    this.event = new CustomEvent('pre-load-config', {
                        detail: {
                            layoutSchema: layoutSchema
                        }
                    });
                    window.dispatchEvent(this.event);
                }
            }
            checkFieldType(fieldType, value, showFieldOn) {
                return (fieldType == value && (!showFieldOn || this[showFieldOn]));
            }
            _toggle(e) {
                var fieldIndex = e.model.__data.index;
                var field = e.model.__data.item;
                field.value = !field.value;
                field.label = (field.value) ? field.labelOn : field.labelOff;
                this.popupConfig.fields[fieldIndex] = field;
                var tmp = this.popupConfig;
                this[field.modelKey] = field.value;
                this._reRenderPopup(tmp);
                //this.onBeforeLoadConfig(this.popupConfig);
            }


            loadJSON(fileName, callback) {
                var xobj = new XMLHttpRequest();
                //xobj.overrideMimeType("application/json");
                xobj.open('GET', fileName, true);
                xobj.onreadystatechange = function() {
                    if (xobj.readyState === 4 && xobj.status === 200) {
                        // Required use of an anonymous callback 
                        // as .open() will NOT return a value but simply returns undefined in asynchronous mode
                        callback(xobj.responseText);
                    }
                };
                xobj.send(null);
            }
            _addMoreField(e) {
                var fieldName = e.model.__data.item.name;
                var fieldIndex = this.popupConfig.fields.findIndex(function(field) {
                    return field.name == fieldName;
                });
                var tmp = this.popupConfig;
                tmp.fields[fieldIndex].values.push("");
                this._reRenderPopup(tmp);
            }
            _hasMoreField(index) {
                return index > 0;
            }
            _removeField(e) {
                var fieldName = e.model.__data.item.name;
                var fieldIndex = this.popupConfig.fields.findIndex(function(field) {
                    return field.name == fieldName;
                });
                var valueIndex = e.model.__data.itemIndex;
                var tmp = this.popupConfig;
                tmp.fields[fieldIndex].values.splice(valueIndex, 1);
                this._reRenderPopup(tmp);
            }
            _addIconClassName(className, index) {
                return className + ((index == 0) ? ' first-child' : ' not-first-child');
            }
            _addDisplayClassName(className, isError) {
                return className + ((!isError) ? ' display-none' : ' display-block');
            }
            _getItemName(itemName, index) {
                return itemName + "[" + index + "]";

            }
            _reRenderPopup(updatePopupConfig, otherProperties) {
                otherProperties = otherProperties || [];
                this.set('popupConfig', []);
                this.$.createpopup.render();
                this.set('popupConfig', updatePopupConfig);
                otherProperties.forEach(function(property){
                    this.set(property.name, property.value);
                }.bind(this));
                this.$.createpopup.render();
            }
            _openFileBrowse() {
                this.shadowRoot.getElementById('profilex-image-file').click();
            }
            _showPreview() {
                var photo = this.shadowRoot.getElementById('profilex-image-file');
                var file = photo.files[0];

                var preview = this.shadowRoot.getElementById('profilex-image-preview');
                var reader = new FileReader();

                reader.onload = function(e) {
                    preview.setAttribute('src', e.target.result);
                };

                reader.readAsDataURL(file);
            }
        }

        window.customElements.define(TrmbCreatePopup.is, TrmbCreatePopup);
    </script>
</dom-module>